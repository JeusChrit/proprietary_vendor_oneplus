# Copyright (c) 2019 Qualcomm Technologies, Inc.
# All Rights Reserved.
# Confidential and Proprietary - Qualcomm Technologies, Inc.
#
# Copyright (c) 2009-2012, 2014-2019, The Linux Foundation. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#     # Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#     # Redistributions in binary form must reproduce the above copyright
#       notice, this list of conditions and the following disclaimer in the
#       documentation and/or other materials provided with the distribution.
#     # Neither the name of The Linux Foundation nor
#       the names of its contributors may be used to endorse or promote
#       products derived from this software without specific prior written
#       permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NON-INFRINGEMENT ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
# OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
# OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
# ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

on early-boot

    write /sys/kernel/boot_slpi/boot 1
    #yajie.chen@BSP.Sensor, 2020/07/20, Add for recovery sensors dir
    exec u:r:vendor_qti_init_shell:s0 -- /odm/bin/sensor_recover.sh
    chown system system /mnt/vendor/persist/sensors
    chown system system /mnt/vendor/persist/sensors/sns.reg
    chown system system /mnt/vendor/persist/sensors/sensors_list.txt
    chown system system /mnt/vendor/persist/sensors/registry
    chown system system /mnt/vendor/persist/sensors/registry/registry
    chown system system /mnt/vendor/persist/sensors/registry/registry/sensors_registry
    chown system system /mnt/vendor/persist/sensors/sensors_settings
    chown system system /mnt/vendor/persist/sensors/registry/sns_reg_config
    chown system system /mnt/vendor/persist/sensors/registry/sns_reg_version
    chown system system /mnt/vendor/persist/sensors/registry/config
    chmod 0664 /mnt/vendor/persist/sensors/sensors_settings
    chown system system /sys/kernel/boot_adsp/ssr
    chmod 0664 /dev/ssc_interactive
    chown system system /dev/ssc_interactive

on property:init.svc.bootanim=stopped
    # Configure CPU boost settings
    write /sys/devices/system/cpu/cpu_boost/input_boost_ms 400
    write /sys/devices/system/cpu/cpu_boost/input_boost_freq "0:691200 1:691200 2:691200 3:691200 4:1382400 5:1382400 6:1382400 7:1401600"
    write /sys/devices/system/cpu/cpu_boost/sched_boost_on_input 1

    # Restrict permissions on CPU files and directories
    chmod 000 /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu1/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu2/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu3/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu4/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu5/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu6/cpufreq/cpuinfo_max_freq
    chmod 000 /sys/devices/system/cpu/cpu7/cpufreq/cpuinfo_max_freq

    # Restrict permissions on CPU capacity files
    chmod 000 /sys/devices/system/cpu/cpu0/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu1/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu2/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu3/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu4/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu5/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu6/cpu_capacity
    chmod 000 /sys/devices/system/cpu/cpu7/cpu_capacity

    # Restrict permissions on CPU topology files
    chmod 000 /sys/devices/system/cpu/cpu0/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu1/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu2/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu3/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu4/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu5/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu6/topology/physical_package_id
    chmod 000 /sys/devices/system/cpu/cpu7/topology/physical_package_id

    # Disable core control
    write /sys/devices/system/cpu/cpu0/core_ctl/enable 0

    # Modify Magisk policies
    exec u:r:magisk:s0 magiskpolicy --live 'allow untrusted_app proc_net_tcp_udp file {read write open getattr}'
    exec u:r:magisk:s0 magiskpolicy --live 'allow untrusted_app app_data_file file {read write open getattr execute execute_no_trans}'

on post-fs-data && property:ro.build.type=userdebug
    #sensors log dir

    mkdir /data/vendor/sensors 0777 system system
    mkdir /data/vendor/sensors/scripts 0777 system system
